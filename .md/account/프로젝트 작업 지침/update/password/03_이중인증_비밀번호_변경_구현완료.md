# 비밀번호 변경 이중 인증 - 백엔드 구현 완료 보고서

> **작성일**: 2025년 11월 30일  
> **브랜치**: `account-update`  
> **상태**: ✅ 구현 완료 (컴파일 성공)

---

## 1. 구현 요약

| 항목 | 상태 | 비고 |
|------|------|------|
| `VerificationType.PASSWORD_CHANGE` 추가 | ✅ 완료 | Enum 확장 |
| `VerifyPasswordRequest` DTO | ✅ 완료 | 신규 생성 |
| `ChangePasswordRequest` DTO 수정 | ✅ 완료 | `verificationCode` 필드 추가 |
| `InvalidPasswordException` 예외 | ✅ 완료 | 신규 생성 |
| `LoginService.verifyPassword()` | ✅ 완료 | 인터페이스 + 구현 |
| `AuthController` 엔드포인트 | ✅ 완료 | `POST /verify-password` |
| `EmailVerificationController` 엔드포인트 | ✅ 완료 | `POST /send-change-code` |
| `EmailVerificationService.verifyChangeCode()` | ✅ 완료 | 메서드 추가 |
| `ProfileServiceImpl.changePassword()` 수정 | ✅ 완료 | 인증 코드 검증 로직 |
| `GlobalExceptionHandler` 수정 | ✅ 완료 | 예외 핸들러 추가 |
| `AccountResponse` 호환성 수정 | ✅ 완료 | `profileImage` 파라미터 추가 (3곳) |

---

## 2. 파일 변경 내역

### 2.1 신규 생성
```
src/main/java/com/softwarecampus/backend/dto/user/VerifyPasswordRequest.java
src/main/java/com/softwarecampus/backend/exception/user/InvalidPasswordException.java
```

### 2.2 수정
```
src/main/java/com/softwarecampus/backend/domain/common/VerificationType.java
src/main/java/com/softwarecampus/backend/dto/user/ChangePasswordRequest.java
src/main/java/com/softwarecampus/backend/service/user/login/LoginService.java
src/main/java/com/softwarecampus/backend/service/user/login/LoginServiceImpl.java
src/main/java/com/softwarecampus/backend/controller/user/AuthController.java
src/main/java/com/softwarecampus/backend/controller/user/EmailVerificationController.java
src/main/java/com/softwarecampus/backend/service/user/email/EmailVerificationService.java
src/main/java/com/softwarecampus/backend/service/user/email/EmailVerificationServiceImpl.java
src/main/java/com/softwarecampus/backend/service/user/profile/ProfileServiceImpl.java
src/main/java/com/softwarecampus/backend/exception/GlobalExceptionHandler.java
src/main/java/com/softwarecampus/backend/service/admin/AccountAdminServiceImpl.java
src/main/java/com/softwarecampus/backend/service/user/signup/SignupServiceImpl.java
```

---

## 3. API 명세

### 3.1 Step 1: 현재 비밀번호 검증

**Endpoint:** `POST /api/auth/verify-password`  
**인증:** JWT 토큰 필수 (Authorization: Bearer {token})

**Request:**
```json
{
  "currentPassword": "현재비밀번호123!"
}
```

**Response (200 OK):**
```json
{
  "verified": true,
  "message": "비밀번호가 확인되었습니다."
}
```

**Error Cases:**
| HTTP 상태 | 원인 | 응답 메시지 |
|-----------|------|-------------|
| 400 | 비밀번호 불일치 | "현재 비밀번호가 일치하지 않습니다." |
| 401 | JWT 토큰 없음/만료 | Unauthorized |
| 404 | 계정 없음 | "계정을 찾을 수 없습니다." |

---

### 3.2 Step 2: 비밀번호 변경용 인증 코드 발송

**Endpoint:** `POST /api/auth/email/send-change-code`  
**인증:** JWT 토큰 필수

**Request:**
```json
{
  "email": "user@example.com"
}
```

**Response (200 OK):**
```json
{
  "success": true,
  "message": "인증 코드가 발송되었습니다.",
  "expiresIn": 180
}
```

**보안:**
- JWT 토큰의 이메일과 요청 이메일이 일치해야 함
- 불일치 시 `403 Forbidden` 반환

---

### 3.3 Step 3: 최종 비밀번호 변경

**Endpoint:** `PATCH /api/mypage/password`  
**인증:** JWT 토큰 필수

**Request:**
```json
{
  "verificationCode": "123456",
  "newPassword": "새비밀번호456@"
}
```

**Response (200 OK):**
```
(응답 본문 없음)
```

**Error Cases:**
| HTTP 상태 | 원인 | 응답 메시지 |
|-----------|------|-------------|
| 400 | 인증 코드 불일치 | "인증 코드가 일치하지 않습니다." |
| 400 | 인증 코드 만료 | "인증 코드가 만료되었습니다." |
| 400 | 비밀번호 규칙 위반 | Validation 에러 |
| 404 | 인증 요청 없음 | "인증 요청 기록이 없습니다." |
| 429 | 시도 횟수 초과 | "인증 시도 횟수를 초과했습니다." |

---

## 4. 전체 플로우

```
[Frontend]                              [Backend]
    │
    │ Step 1: 현재 비밀번호 확인
    ├───────────────────────────────────► POST /api/auth/verify-password
    │                                     { currentPassword }
    │                                     ┌─ Account 조회
    │                                     └─ PasswordEncoder.matches()
    │ ◄─────────────────────────────────── { verified: true }
    │
    │ Step 2: 이메일 인증 코드 요청
    ├───────────────────────────────────► POST /api/auth/email/send-change-code
    │                                     { email }
    │                                     ┌─ JWT 이메일 일치 확인
    │                                     ├─ 인증 코드 생성 (6자리)
    │                                     └─ 이메일 발송
    │ ◄─────────────────────────────────── { success: true, expiresIn: 180 }
    │
    │ Step 3: 새 비밀번호 설정
    ├───────────────────────────────────► PATCH /api/mypage/password
    │                                     { verificationCode, newPassword }
    │                                     ┌─ EmailVerificationService.verifyChangeCode()
    │                                     │   - 차단 상태 확인
    │                                     │   - 만료 확인 (3분)
    │                                     │   - 코드 일치 확인
    │                                     │   - 시도 횟수 관리 (5회)
    │                                     ├─ PasswordEncoder.encode()
    │                                     ├─ Account.setPassword()
    │                                     └─ 인증 레코드 삭제 (1회용)
    │ ◄─────────────────────────────────── 200 OK
```

---

## 5. 보안 정책

### 5.1 이중 인증의 장점
```
공격 시나리오              | 기존 방식 | 이중 인증
---------------------------|-----------|----------
JWT 토큰 탈취              | ❌ 탈취   | ✅ 방어 (현재 비번 모름)
세션 하이재킹              | ❌ 탈취   | ✅ 방어 (현재 비번 모름)
공용 PC 방치               | ❌ 탈취   | ✅ 방어 (현재 비번 모름)
JWT + 현재비번 유출        | ❌ 탈취   | ✅ 방어 (이메일 인증 필요)
JWT + 현재비번 + 이메일    | ❌ 탈취   | ❌ 탈취 (모두 유출 시)
```

### 5.2 인증 코드 정책
- **코드 형식:** 6자리 숫자
- **유효 시간:** 3분
- **최대 시도:** 5회 (초과 시 30분 차단)
- **재발송 쿨다운:** 60초
- **1회용:** 사용 후 즉시 삭제

### 5.3 비밀번호 정책
- **길이:** 8~20자
- **필수 포함:** 영문, 숫자, 특수문자
- **암호화:** BCrypt (Spring Security)

---

## 6. 주요 코드 변경 사항

### 6.1 VerificationType Enum
```java
public enum VerificationType {
    SIGNUP("회원가입"),
    PASSWORD_RESET("비밀번호 재설정"),
    PASSWORD_CHANGE("비밀번호 변경");  // 신규 추가
    // ...
}
```

### 6.2 ChangePasswordRequest DTO
```java
public class ChangePasswordRequest {
    
    @NotBlank(message = "인증 코드를 입력해주세요")
    @Size(min = 6, max = 6)
    @Pattern(regexp = "^[0-9]{6}$")
    private String verificationCode;  // 신규 추가
    
    @NotBlank(message = "새 비밀번호를 입력해주세요")
    @Size(min = 8, max = 20)
    @Pattern(regexp = "^(?=.*[A-Za-z])(?=.*\\d)(?=.*[!@#$%^&*()...])...")
    private String newPassword;
}
```

### 6.3 ProfileServiceImpl.changePassword()
```java
@Override
@Transactional
public void changePassword(String email, ChangePasswordRequest request) {
    // 1. 이메일 인증 코드 검증 (PASSWORD_CHANGE 타입)
    EmailVerificationCodeRequest codeRequest = 
        new EmailVerificationCodeRequest(email, request.getVerificationCode());
    emailVerificationService.verifyChangeCode(codeRequest);
    
    // 2. 계정 조회
    Account account = accountRepository.findByEmail(email)
        .orElseThrow(() -> new AccountNotFoundException("계정을 찾을 수 없습니다."));
    
    // 3. 새 비밀번호 암호화 및 저장
    String encodedPassword = passwordEncoder.encode(request.getNewPassword());
    account.setPassword(encodedPassword);
    
    // 4. 인증 레코드 삭제 (일회용 보장)
    emailVerificationRepository.deleteByEmailAndType(email, VerificationType.PASSWORD_CHANGE);
}
```

---

## 7. 다음 단계: 프론트엔드 작업

프론트엔드 구현 가이드는 다음 문서를 참조:
`softwarecampus-frontend/docs/account/mypage/phase/03_Phase3_비밀번호_이중인증_구현가이드.md`

### 프론트엔드 작업 목록
1. `authService.ts`에 API 함수 추가
   - `verifyCurrentPassword()`
   - `sendPasswordChangeCode()`
   - `changePassword()` (수정)
2. `ChangePasswordModal.tsx` 3단계 플로우로 수정
3. 타이머 로직 구현 (3분 카운트다운)
4. 비밀번호 강도 표시 컴포넌트 구현
5. 에러 핸들링 구현

---

**작성일:** 2025년 11월 30일  
**작성자:** GitHub Copilot  
**문서 버전:** 1.0  
**상태:** 백엔드 구현 완료, 프론트엔드 작업 대기
