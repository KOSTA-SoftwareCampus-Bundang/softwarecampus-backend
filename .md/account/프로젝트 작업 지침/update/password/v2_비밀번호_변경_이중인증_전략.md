# 비밀번호 변경 이중 인증 API - v2 전략 설계

> 작성일: 2025-11-30  
> 브랜치: `account-update-v2`  
> 버전: v2 (이중 인증 방식)

---

## 1. 개요

### 1.1 목적
로그인한 사용자가 **현재 비밀번호 확인 + 이메일 인증**을 통해 안전하게 비밀번호를 변경하는 기능

### 1.2 v1 vs v2 비교

| 구분 | v1 (기존) | v2 (신규) |
|------|-----------|-----------|
| **용도** | 비밀번호 찾기 (비로그인) | 비밀번호 변경 (로그인 상태) |
| **인증 단계** | 1단계 (이메일 인증) | 2단계 (비밀번호 확인 + 이메일 인증) |
| **타입** | `PASSWORD_RESET` | `PASSWORD_CHANGE` |
| **보안** | 이메일 인증만 | 세션 탈취 방어 가능 |

### 1.3 전체 플로우

```
┌─────────────────────────────────────────────────────────────────┐
│                     마이페이지 - 비밀번호 변경                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: 현재 비밀번호 확인                                      │
│  ─────────────────────────────────────────────────────────────  │
│  POST /api/auth/verify-password                                 │
│  Request: { "currentPassword": "xxx" }                          │
│  Response: 200 OK / 400 Bad Request                             │
└─────────────────────────────────────────────────────────────────┘
                              │ 성공
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 2: 이메일 인증 코드 발송                                   │
│  ─────────────────────────────────────────────────────────────  │
│  POST /api/auth/email/send-change-code                          │
│  (JWT에서 이메일 추출, type: PASSWORD_CHANGE)                    │
│  Response: 200 OK + 이메일로 6자리 코드 발송                     │
└─────────────────────────────────────────────────────────────────┘
                              │ 코드 입력
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 3: 새 비밀번호 설정                                        │
│  ─────────────────────────────────────────────────────────────  │
│  PUT /api/mypage/password                                       │
│  Request: { "code": "123456", "newPassword": "xxx" }            │
│  (type: PASSWORD_CHANGE로 검증)                                 │
│  Response: 200 OK                                               │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 구현 작업 목록

### 2.1 작업 순서

| 순서 | 작업 | 파일 | 상태 |
|------|------|------|------|
| 1 | `PASSWORD_CHANGE` enum 추가 | `VerificationType.java` | ✅ 완료 |
| 2 | `EmailConstants` 상수 추가 | `EmailConstants.java` | ✅ 완료 |
| 3 | `EmailSendServiceImpl` switch case 추가 | `EmailSendServiceImpl.java` | ✅ 완료 |
| 4 | `verify-password` API 신규 | `AuthController.java` | ✅ 완료 |
| 5 | `send-change-code` API 신규 | `EmailVerificationController.java` | ✅ 완료 |
| 6 | `verifyChangeCode` 메서드 추가 | `EmailVerificationService(Impl).java` | ✅ 완료 |
| 7 | `changePassword` 메서드 추가 | `ProfileService(Impl).java` | ✅ 완료 |
| 8 | `PUT /password` 수정 | `MyPageController.java` | ✅ 완료 |
| 9 | 이메일 템플릿 확인 | `password-change-verification.html` | ✅ 완료 |

### 2.2 의존성 관계

```
[1] PASSWORD_CHANGE enum
         │
         ├──► [2] EmailConstants
         │          │
         │          └──► [3] EmailSendServiceImpl
         │
         ├──► [5] send-change-code API
         │
         └──► [6] PUT /password 수정

[4] verify-password API (독립적)
```

---

## 3. API 명세

### 3.1 현재 비밀번호 확인 (신규)

**Endpoint:** `POST /api/auth/verify-password`

**인증:** JWT 토큰 필수

**Request:**
```json
{
  "currentPassword": "현재비밀번호123!"
}
```

**Response (200 OK):**
```json
{
  "verified": true,
  "message": "비밀번호가 확인되었습니다."
}
```

**Error Cases:**

| 상태 코드 | 상황 | 응답 |
|----------|------|------|
| 400 | 비밀번호 불일치 | `"현재 비밀번호가 일치하지 않습니다."` |
| 401 | JWT 없음/만료 | `"인증이 필요합니다."` |
| 404 | 계정 없음 | `"계정을 찾을 수 없습니다."` |

---

### 3.2 비밀번호 변경용 인증 코드 발송 (신규)

**Endpoint:** `POST /api/auth/email/send-change-code`

**인증:** JWT 토큰 필수

**Request:** (body 없음 - JWT에서 이메일 추출)
```json
{}
```

**Response (200 OK):**
```json
{
  "success": true,
  "message": "인증 코드가 발송되었습니다.",
  "expiresAt": "2025-11-30T12:03:00"
}
```

**Error Cases:**

| 상태 코드 | 상황 | 응답 |
|----------|------|------|
| 401 | JWT 없음/만료 | `"인증이 필요합니다."` |
| 429 | 재발송 대기 (60초) | `"잠시 후 다시 시도해주세요."` |
| 500 | 이메일 발송 실패 | `"이메일 발송에 실패했습니다."` |

---

### 3.3 비밀번호 변경 (수정)

**Endpoint:** `PUT /api/mypage/password`

**인증:** JWT 토큰 필수

**Request:**
```json
{
  "code": "123456",
  "newPassword": "newPassword456@"
}
```

**⚠️ 변경사항:** 
- 기존: `PASSWORD_RESET` 타입으로 검증
- 변경: `PASSWORD_CHANGE` 타입으로 검증

**Response (200 OK):**
```
(응답 본문 없음 - 빈 body)
```

---

## 4. 구현 상세

### 4.1 VerificationType enum 수정

```java
// src/main/java/com/.../domain/common/VerificationType.java

public enum VerificationType {
    SIGNUP,           // 회원가입 인증
    PASSWORD_RESET,   // 비밀번호 찾기 (비로그인)
    PASSWORD_CHANGE   // 비밀번호 변경 (로그인) ← 추가
}
```

### 4.2 VerifyPasswordRequest DTO (신규)

```java
// src/main/java/com/.../dto/user/VerifyPasswordRequest.java

@Getter
@NoArgsConstructor
@AllArgsConstructor
public class VerifyPasswordRequest {
    
    @NotBlank(message = "현재 비밀번호를 입력해주세요")
    private String currentPassword;
}
```

### 4.3 AuthController (신규 또는 기존에 추가)

```java
// src/main/java/com/.../controller/user/AuthController.java

@PostMapping("/verify-password")
public ResponseEntity<?> verifyPassword(
        @AuthenticationPrincipal UserDetails userDetails,
        @Valid @RequestBody VerifyPasswordRequest request) {
    
    String email = userDetails.getUsername();
    boolean verified = authService.verifyPassword(email, request.getCurrentPassword());
    
    if (verified) {
        return ResponseEntity.ok(Map.of(
            "verified", true,
            "message", "비밀번호가 확인되었습니다."
        ));
    } else {
        return ResponseEntity.badRequest().body(Map.of(
            "verified", false,
            "message", "현재 비밀번호가 일치하지 않습니다."
        ));
    }
}
```

### 4.4 EmailVerificationController 수정

```java
// 기존 파일에 추가

/**
 * 5. 비밀번호 변경 인증 코드 발송 (로그인 사용자용)
 * POST /api/auth/email/send-change-code
 */
@PostMapping("/send-change-code")
public ResponseEntity<EmailVerificationResponse> sendPasswordChangeCode(
        @AuthenticationPrincipal UserDetails userDetails
) {
    String email = userDetails.getUsername();
    log.info("비밀번호 변경 인증 코드 발송 요청 - type: {}", VerificationType.PASSWORD_CHANGE);
    
    EmailVerificationRequest request = new EmailVerificationRequest();
    request.setEmail(email);
    request.setType(VerificationType.PASSWORD_CHANGE);
    
    EmailVerificationResponse response = verificationService.sendVerificationCode(request);
    return ResponseEntity.ok(response);
}
```

### 4.5 ProfileServiceImpl 수정

```java
// 변경 전
emailVerificationService.verifyResetCode(codeRequest);
emailVerificationRepository.deleteByEmailAndType(email, VerificationType.PASSWORD_RESET);

// 변경 후 (PASSWORD_CHANGE 사용)
emailVerificationService.verifyChangeCode(codeRequest);  // 새 메서드 필요
emailVerificationRepository.deleteByEmailAndType(email, VerificationType.PASSWORD_CHANGE);
```

---

## 5. 보안 고려사항

### 5.1 이중 인증의 보안 강화점

| 공격 시나리오 | v1 (단일 인증) | v2 (이중 인증) |
|--------------|---------------|---------------|
| 세션 탈취 | ❌ 취약 (이메일만 접근하면 변경 가능) | ✅ 방어 (현재 비번도 필요) |
| 피싱 | ❌ 취약 | ⚠️ 부분 방어 |
| 브루트포스 | ⚠️ 이메일 인증으로 제한 | ✅ 비번 확인 + 이메일 인증 |

### 5.2 Rate Limiting

| API | 제한 |
|-----|------|
| `verify-password` | 5회 실패 시 30분 차단 |
| `send-change-code` | 60초 재발송 대기 |
| `PUT /password` | 5회 실패 시 30분 차단 |

---

## 6. 테스트 시나리오

### 6.1 정상 플로우

```
1. POST /api/auth/verify-password (현재 비밀번호 입력)
   → 200 OK

2. POST /api/auth/email/send-change-code
   → 200 OK, 이메일 수신

3. PUT /api/mypage/password (인증코드 + 새 비밀번호)
   → 200 OK
```

### 6.2 에러 케이스

| 케이스 | API | 예상 응답 |
|--------|-----|----------|
| 현재 비밀번호 틀림 | verify-password | 400 |
| JWT 없음 | 모든 API | 401 |
| 인증 코드 틀림 | PUT /password | 400 |
| 인증 코드 만료 | PUT /password | 400 |
| 5회 실패 | PUT /password | 429 |

---

## 7. 다음 단계

1. [x] VerificationType에 PASSWORD_CHANGE 추가
2. [x] EmailConstants에 상수 추가
3. [x] EmailSendServiceImpl에 switch case 추가
4. [x] verify-password API 구현
5. [x] send-change-code API 구현
6. [x] verifyChangeCode 메서드 추가
7. [x] changePassword 메서드 추가
8. [x] MyPageController 수정 (PASSWORD_CHANGE 사용)
9. [ ] 단위 테스트 작성
10. [ ] 통합 테스트 진행
11. [ ] 프론트엔드 연동

---

**작성일:** 2025년 11월 30일  
**작성자:** GitHub Copilot  
**문서 버전:** 2.0
