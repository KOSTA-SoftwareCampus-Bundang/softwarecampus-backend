# SMTP ì´ë©”ì¼ ì¸ì¦ ê¸°ëŠ¥ - ì „ëµ ì„¤ê³„

## ğŸ“‹ ê°œìš”

**ëª©ì :** íšŒì›ê°€ì… ë° ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì‹œ ì´ë©”ì¼ ì¸ì¦ ì½”ë“œ ë°©ì‹ êµ¬í˜„  
**ë°©ì‹:** 6ìë¦¬ ìˆ«ì ì½”ë“œ ì „ì†¡ ë° ê²€ì¦  
**SMTP:** Google Gmail ê³„ì • ì‚¬ìš©  
**ì €ì¥ì†Œ:** DB (email_verification í…Œì´ë¸”)

---

## ğŸ¯ êµ¬í˜„ ë²”ìœ„

### 1. ì¸ì¦ ì‹œë‚˜ë¦¬ì˜¤

#### A. íšŒì›ê°€ì… ì´ë©”ì¼ ì¸ì¦
```
1. ì‚¬ìš©ìê°€ ì´ë©”ì¼ ì…ë ¥
2. POST /api/auth/email/send-verification
   â†’ 6ìë¦¬ ì½”ë“œ ìƒì„± + ì´ë©”ì¼ ë°œì†¡
3. ì‚¬ìš©ìê°€ ì½”ë“œ ì…ë ¥
4. POST /api/auth/email/verify
   â†’ ì½”ë“œ ê²€ì¦ ì„±ê³µ
5. POST /api/auth/signup
   â†’ ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ ìƒíƒœì—ì„œë§Œ ê°€ì… í—ˆìš©
```

#### B. ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼ ì¸ì¦
```
1. ì‚¬ìš©ìê°€ ì´ë©”ì¼ ì…ë ¥ (ê°€ì…ëœ ê³„ì •)
2. POST /api/auth/email/send-reset-code
   â†’ 6ìë¦¬ ì½”ë“œ ìƒì„± + ì´ë©”ì¼ ë°œì†¡
3. ì‚¬ìš©ìê°€ ì½”ë“œ ì…ë ¥
4. POST /api/auth/email/verify-reset
   â†’ ì½”ë“œ ê²€ì¦ + ì„ì‹œ í† í° ë°œê¸‰
5. POST /api/auth/password/reset
   â†’ ì„ì‹œ í† í°ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •
```

---

## ğŸ—ï¸ ì•„í‚¤í…ì²˜ ì„¤ê³„

### 1. ê¸°ìˆ  ìŠ¤íƒ ì¶”ê°€

#### ì˜ì¡´ì„± (pom.xml)
```xml
<!-- Spring Boot Mail Starter -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-mail</artifactId>
</dependency>
```

#### SMTP ì„¤ì • (application.properties)
```properties
# Gmail SMTP ì„¤ì •
spring.mail.host=smtp.gmail.com
spring.mail.port=587
spring.mail.username=${MAIL_USERNAME}
spring.mail.password=${MAIL_APP_PASSWORD}
spring.mail.properties.mail.smtp.auth=true
spring.mail.properties.mail.smtp.starttls.enable=true
spring.mail.properties.mail.smtp.starttls.required=true
spring.mail.properties.mail.smtp.connectiontimeout=5000
spring.mail.properties.mail.smtp.timeout=5000
spring.mail.properties.mail.smtp.writetimeout=5000

# ì´ë©”ì¼ ë°œì‹ ì ì •ë³´
spring.mail.properties.mail.smtp.from=noreply@softwarecampus.com

# ì´ë©”ì¼ ì¸ì¦ ì •ì±…
email.verification.code-length=6
email.verification.expiry-minutes=3
email.verification.max-attempts=5
email.verification.resend-cooldown-seconds=60
email.verification.block-duration-minutes=30
```

#### í™˜ê²½ë³€ìˆ˜ (.env)
```properties
MAIL_USERNAME=your-gmail@gmail.com
MAIL_APP_PASSWORD=your-app-specific-password
```

**âš ï¸ ë³´ì•ˆ ê²½ê³ :**
- **ì‹¤ì œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë¬¸ì„œë‚˜ Gitì— ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”**
- `.env` íŒŒì¼ì€ ë°˜ë“œì‹œ `.gitignore`ì— ì¶”ê°€í•˜ì„¸ìš”
- ë¹„ë°€ë²ˆí˜¸ ë…¸ì¶œ ì‹œ ì¦‰ì‹œ íê¸° í›„ ì¬ìƒì„± í•„ìš”

---

### 2. ë°ì´í„° ëª¨ë¸

#### EmailVerification ì—”í‹°í‹° (DB ì €ì¥ìš©)
```java
@Entity
@Table(name = "email_verification")
@EntityListeners(AuditingEntityListener.class)
public class EmailVerification {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false, length = 100)
    private String email;
    
    @Column(nullable = false, length = 6)
    private String code;  // 6ìë¦¬ ìˆ«ì ì½”ë“œ
    
    @Enumerated(EnumType.STRING)
    @Column(nullable = false, length = 20)
    private VerificationType type;
    
    @Column(nullable = false)
    private LocalDateTime expiresAt;
    
    @Column(nullable = false)
    private boolean verified = false;
    
    @Column(nullable = false)
    private int attempts = 0;
    
    @CreatedDate
    @Column(nullable = false, updatable = false)
    private LocalDateTime createdAt;
    
    private LocalDateTime verifiedAt;
    
    private LocalDateTime blockedUntil;  // ì¬ì‹œë„ ì°¨ë‹¨ ì¢…ë£Œ ì‹œê°„
    
    // ì¸ì¦ ì™„ë£Œ ì²˜ë¦¬
    public void markAsVerified() {
        this.verified = true;
        this.verifiedAt = LocalDateTime.now();
    }
    
    // ì‹œë„ íšŸìˆ˜ ì¦ê°€
    public void incrementAttempts() {
        this.attempts++;
    }
    
    // ë§Œë£Œ ì—¬ë¶€ í™•ì¸
    public boolean isExpired() {
        return LocalDateTime.now().isAfter(expiresAt);
    }
    
    // ìµœëŒ€ ì‹œë„ ì´ˆê³¼ ì—¬ë¶€
    public boolean isAttemptsExceeded() {
        return attempts >= 5;
    }
    
    // ì°¨ë‹¨ ì—¬ë¶€ í™•ì¸
    public boolean isBlocked() {
        return blockedUntil != null && LocalDateTime.now().isBefore(blockedUntil);
    }
    
    // ì°¨ë‹¨ ì„¤ì • (30ë¶„)
    public void blockForDuration(int minutes) {
        this.blockedUntil = LocalDateTime.now().plusMinutes(minutes);
    }
    
    // ë‚¨ì€ ì°¨ë‹¨ ì‹œê°„ (ë¶„)
    public long getRemainingBlockMinutes() {
        if (blockedUntil == null || LocalDateTime.now().isAfter(blockedUntil)) {
            return 0;
        }
        return ChronoUnit.MINUTES.between(LocalDateTime.now(), blockedUntil);
    }
}
```

#### VerificationType Enum
```java
public enum VerificationType {
    SIGNUP("íšŒì›ê°€ì…"),
    PASSWORD_RESET("ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •");
    
    private final String description;
    
    VerificationType(String description) {
        this.description = description;
    }
    
    public String getDescription() {
        return description;
    }
}
```

---

### 3. ë ˆì´ì–´ êµ¬ì¡°

#### íŒ¨í‚¤ì§€ êµ¬ì¡°
```
src/main/java/com/softwarecampus/backend/
â”œâ”€â”€ model/
â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â””â”€â”€ EmailVerification.java
â”‚   â”œâ”€â”€ enums/
â”‚   â”‚   â””â”€â”€ VerificationType.java
â”‚   â””â”€â”€ dto/
â”‚       â””â”€â”€ email/
â”‚           â”œâ”€â”€ EmailVerificationRequest.java
â”‚           â”œâ”€â”€ EmailVerificationResponse.java
â”‚           â”œâ”€â”€ EmailVerificationCodeRequest.java
â”‚           â””â”€â”€ (ê¸°íƒ€ DTO)
â”œâ”€â”€ repository/
â”‚   â””â”€â”€ EmailVerificationRepository.java
â”œâ”€â”€ service/
â”‚   â””â”€â”€ email/
â”‚       â”œâ”€â”€ EmailVerificationService.java
â”‚       â”œâ”€â”€ EmailVerificationServiceImpl.java
â”‚       â”œâ”€â”€ EmailSendService.java
â”‚       â””â”€â”€ EmailSendServiceImpl.java
â”œâ”€â”€ controller/
â”‚   â””â”€â”€ EmailVerificationController.java
â”œâ”€â”€ exception/
â”‚   â””â”€â”€ email/
â”‚       â”œâ”€â”€ EmailVerificationException.java
â”‚       â”œâ”€â”€ TooManyAttemptsException.java
â”‚       â”œâ”€â”€ EmailSendException.java
â”‚       â””â”€â”€ VerificationCodeExpiredException.java
â””â”€â”€ util/
    â””â”€â”€ email/
        â””â”€â”€ VerificationCodeGenerator.java
```

**ì°¸ê³ :** ê¸°ì¡´ í”„ë¡œì íŠ¸ì˜ `model`, `repository`, `service`, `controller` êµ¬ì¡°ë¥¼ ë”°ë¦…ë‹ˆë‹¤.

---

## ğŸ“ API ëª…ì„¸

### 1. ì¸ì¦ ì½”ë“œ ë°œì†¡ (íšŒì›ê°€ì…)

**Endpoint:** `POST /api/auth/email/send-verification`

**Request:**
```json
{
  "email": "user@example.com",
  "type": "SIGNUP"
}
```

**Response (200 OK):**
```json
{
  "message": "ì¸ì¦ ì½”ë“œê°€ ì´ë©”ì¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤",
  "email": "user@example.com",
  "expiresIn": 180,
  "canResendAt": "2025-01-15T10:31:00Z"
}
```

**Error Cases:**
- 400: ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼
- 400: ì´ë©”ì¼ í˜•ì‹ ì˜¤ë¥˜
- 429: ì¬ì „ì†¡ ì¿¨ë‹¤ìš´ (60ì´ˆ ì´ë‚´)
- 429: ìµœëŒ€ ì‹œë„ ì´ˆê³¼ë¡œ ì¸í•œ ì°¨ë‹¨ (30ë¶„)
- 500: ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨

---

### 2. ì¸ì¦ ì½”ë“œ ê²€ì¦ (íšŒì›ê°€ì…)

**Endpoint:** `POST /api/auth/email/verify`

**Request:**
```json
{
  "email": "user@example.com",
  "code": "123456",
  "type": "SIGNUP"
}
```

**Response (200 OK):**
```json
{
  "verified": true,
  "message": "ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤"
}
```

**Error Cases:**
- 400: ì¸ì¦ ì½”ë“œ ë¶ˆì¼ì¹˜
- 400: ì¸ì¦ ì½”ë“œ ë§Œë£Œ
- 429: ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ì´ˆê³¼ (5íšŒ) - 30ë¶„ ì°¨ë‹¨
- 404: ì¸ì¦ ìš”ì²­ ì—†ìŒ

---

### 3. ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì½”ë“œ ë°œì†¡

**Endpoint:** `POST /api/auth/email/send-reset-code`

**Request:**
```json
{
  "email": "user@example.com"
}
```

**Response (200 OK):**
```json
{
  "message": "ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì½”ë“œê°€ ì´ë©”ì¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤",
  "email": "user@example.com",
  "expiresIn": 180,
  "canResendAt": "2025-01-15T10:31:00Z"
}
```

**Error Cases:**
- 404: ê°€ì…ë˜ì§€ ì•Šì€ ì´ë©”ì¼
- 429: ì¬ì „ì†¡ ì¿¨ë‹¤ìš´ (60ì´ˆ ì´ë‚´)
- 429: ìµœëŒ€ ì‹œë„ ì´ˆê³¼ë¡œ ì¸í•œ ì°¨ë‹¨ (30ë¶„)
- 500: ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨

---

### 4. ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì½”ë“œ ê²€ì¦

**Endpoint:** `POST /api/auth/email/verify-reset`

**Request:**
```json
{
  "email": "user@example.com",
  "code": "123456"
}
```

**Response (200 OK):**
```json
{
  "verified": true,
  "resetToken": "example.jwt.token",
  "message": "ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¹„ë°€ë²ˆí˜¸ë¥¼ ì¬ì„¤ì •í•˜ì„¸ìš”",
  "expiresIn": 300
}
```

**âš ï¸ ì°¸ê³ :** `resetToken`ì€ ì˜ˆì‹œ ê°’ì…ë‹ˆë‹¤. ì‹¤ì œ JWTëŠ” ì„œë²„ì—ì„œ ìƒì„±ë©ë‹ˆë‹¤.

**Error Cases:**
- 400: ì¸ì¦ ì½”ë“œ ë¶ˆì¼ì¹˜
- 400: ì¸ì¦ ì½”ë“œ ë§Œë£Œ
- 429: ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ì´ˆê³¼ (5íšŒ) - 30ë¶„ ì°¨ë‹¨
- 404: ì¸ì¦ ìš”ì²­ ì—†ìŒ

---

## ğŸ” ë³´ì•ˆ ì •ì±…

### 1. ì¸ì¦ ì½”ë“œ ìƒì„±
- **í˜•ì‹:** 6ìë¦¬ ìˆ«ì (000000 ~ 999999)
- **ìƒì„±:** `SecureRandom` ì‚¬ìš© (ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥)
- **ì¤‘ë³µ ë°©ì§€:** ë™ì¼ ì´ë©”ì¼/íƒ€ì…ì— ëŒ€í•´ ê¸°ì¡´ ì½”ë“œ ë¬´íš¨í™” í›„ ì‹ ê·œ ìƒì„±

### 2. ìœ íš¨ ê¸°ê°„
- **ë§Œë£Œ ì‹œê°„:** 3ë¶„ (180ì´ˆ)
- **ë§Œë£Œ ì²´í¬:** ê²€ì¦ ì‹œë§ˆë‹¤ `expiresAt` í™•ì¸

### 3. ì‹œë„ ì œí•œ
- **ìµœëŒ€ ì‹œë„:** 5íšŒ
- **ì´ˆê³¼ ì‹œ:** í•´ë‹¹ ì´ë©”ì¼ 30ë¶„ ì°¨ë‹¨, ì½”ë“œ ë¬´íš¨í™”
- **ì°¨ë‹¨ ê¸°ê°„:** 30ë¶„ (ì¬ë°œì†¡ ë° ê²€ì¦ ëª¨ë‘ ì°¨ë‹¨)
- **ì¹´ìš´í„° ì´ˆê¸°í™”:** ì°¨ë‹¨ í•´ì œ í›„ ìƒˆ ì½”ë“œ ë°œì†¡ ì‹œ

### 4. ì¬ì „ì†¡ ì œí•œ
- **ì¿¨ë‹¤ìš´:** 60ì´ˆ
- **ì²´í¬ ë°©ì‹:** DBì˜ `createdAt` ê¸°ì¤€
- **ëª©ì :** ì´ë©”ì¼ ìŠ¤íŒ¨ ë°©ì§€

### 5. ì½”ë“œ ì¬ì‚¬ìš© ë°©ì§€
- **ì¸ì¦ ì™„ë£Œ ì‹œ:** `verified = true` ì„¤ì •
- **ê²€ì¦ ë¡œì§:** `verified == false` ì¸ ì½”ë“œë§Œ í—ˆìš©

### 6. ë°ì´í„° ì •ë¦¬
- **ìë™ ì‚­ì œ:** ë§Œë£Œ 24ì‹œê°„ í›„ ë°°ì¹˜ ì‘ì—…ìœ¼ë¡œ ì‚­ì œ

---

## ğŸ“§ ì´ë©”ì¼ í…œí”Œë¦¿

### HTML í…œí”Œë¦¿ (íšŒì›ê°€ì…)

**ì œëª©:** `[ì†Œí”„íŠ¸ì›¨ì–´ìº í¼ìŠ¤] ì´ë©”ì¼ ì¸ì¦ ì½”ë“œ`

**ë³¸ë¬¸:**
```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background-color: #4A90E2; color: white; padding: 20px; text-align: center; }
        .content { padding: 30px 20px; background-color: #f9f9f9; }
        .code-box { background-color: #fff; border: 2px solid #4A90E2; border-radius: 8px; 
                    padding: 20px; text-align: center; margin: 20px 0; }
        .code { font-size: 32px; font-weight: bold; color: #4A90E2; letter-spacing: 5px; }
        .footer { text-align: center; padding: 20px; font-size: 12px; color: #999; }
        .warning { color: #E74C3C; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ì†Œí”„íŠ¸ì›¨ì–´ìº í¼ìŠ¤</h1>
        </div>
        <div class="content">
            <h2>ì´ë©”ì¼ ì¸ì¦ ì½”ë“œ</h2>
            <p>ì•ˆë…•í•˜ì„¸ìš”,</p>
            <p>íšŒì›ê°€ì…ì„ ì™„ë£Œí•˜ê¸° ìœ„í•´ ì•„ë˜ ì¸ì¦ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            
            <div class="code-box">
                <div class="code">${CODE}</div>
            </div>
            
            <p class="warning">âš ï¸ ì´ ì½”ë“œëŠ” <strong>3ë¶„</strong> ë™ì•ˆ ìœ íš¨í•©ë‹ˆë‹¤.</p>
            <p class="warning">âš ï¸ ì¸ì¦ ì½”ë“œë¥¼ íƒ€ì¸ê³¼ ê³µìœ í•˜ì§€ ë§ˆì„¸ìš”.</p>
            
            <p>ë³¸ì¸ì´ ìš”ì²­í•˜ì§€ ì•Šì€ ê²½ìš°, ì´ ì´ë©”ì¼ì„ ë¬´ì‹œí•˜ì…”ë„ ë©ë‹ˆë‹¤.</p>
        </div>
        <div class="footer">
            <p>Â© 2025 ì†Œí”„íŠ¸ì›¨ì–´ìº í¼ìŠ¤. All rights reserved.</p>
            <p>ë³¸ ë©”ì¼ì€ ë°œì‹  ì „ìš©ì…ë‹ˆë‹¤.</p>
        </div>
    </div>
</body>
</html>
```

### HTML í…œí”Œë¦¿ (ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •)

**ì œëª©:** `[ì†Œí”„íŠ¸ì›¨ì–´ìº í¼ìŠ¤] ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì½”ë“œ`

**ë³¸ë¬¸:** (íšŒì›ê°€ì… í…œí”Œë¦¿ê³¼ ìœ ì‚¬, ì œëª© ë° ì•ˆë‚´ ë¬¸êµ¬ë§Œ ë³€ê²½)

---

## ğŸ› ï¸ êµ¬í˜„ ìƒì„¸

### 1. VerificationCodeGenerator (ìœ í‹¸)

```java
public class VerificationCodeGenerator {
    
    private static final SecureRandom RANDOM = new SecureRandom();
    private static final int CODE_LENGTH = 6;
    
    private VerificationCodeGenerator() {
        throw new UnsupportedOperationException("Utility class");
    }
    
    /**
     * 6ìë¦¬ ìˆ«ì ì¸ì¦ ì½”ë“œ ìƒì„± (ì•”í˜¸í•™ì ìœ¼ë¡œ ì•ˆì „í•œ ë‚œìˆ˜)
     * SecureRandomì˜ ë°”ì´íŠ¸ ë°°ì—´ ê¸°ë°˜ìœ¼ë¡œ ë” ê°•ë ¥í•œ ë¬´ì‘ìœ„ì„± ë³´ì¥
     * @return 000000 ~ 999999
     */
    public static String generate() {
        // ë°”ì´íŠ¸ ë°°ì—´ ê¸°ë°˜ìœ¼ë¡œ ë‚œìˆ˜ ìƒì„± (ë” ê°•ë ¥í•œ ë¬´ì‘ìœ„ì„±)
        byte[] randomBytes = new byte[4];
        RANDOM.nextBytes(randomBytes);
        
        // ë°”ì´íŠ¸ë¥¼ ì •ìˆ˜ë¡œ ë³€í™˜ (ì ˆëŒ“ê°’ ì²˜ë¦¬)
        int randomInt = Math.abs(ByteBuffer.wrap(randomBytes).getInt());
        
        // 6ìë¦¬ ë²”ìœ„ë¡œ ì œí•œ (0 ~ 999999)
        int code = randomInt % 1000000;
        
        return String.format("%06d", code);
    }
}
```

---

### 2. EmailVerificationRepository

```java
public interface EmailVerificationRepository extends JpaRepository<EmailVerification, Long> {
    
    Optional<EmailVerification> findByEmailAndTypeAndVerifiedFalse(
        String email, 
        VerificationType type
    );
    
    Optional<EmailVerification> findTopByEmailAndTypeOrderByCreatedAtDesc(
        String email,
        VerificationType type
    );
    
    void deleteByExpiresAtBeforeAndVerifiedTrue(LocalDateTime threshold);
    
    boolean existsByEmailAndTypeAndVerifiedFalseAndCreatedAtAfter(
        String email,
        VerificationType type,
        LocalDateTime cooldownTime
    );
    
    Optional<EmailVerification> findByEmailAndTypeAndBlockedUntilAfter(
        String email,
        VerificationType type,
        LocalDateTime now
    );
}
```

---

### 3. EmailSendService (ì´ë©”ì¼ ë°œì†¡)

```java
public interface EmailSendService {
    void sendVerificationCode(String to, String code, VerificationType type);
}

@Service
@RequiredArgsConstructor
public class EmailSendServiceImpl implements EmailSendService {
    
    private final JavaMailSender mailSender;
    
    @Value("${spring.mail.properties.mail.smtp.from}")
    private String fromEmail;
    
    @Override
    public void sendVerificationCode(String to, String code, VerificationType type) {
        try {
            MimeMessage message = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(message, true, "UTF-8");
            
            helper.setFrom(fromEmail);
            helper.setTo(to);
            helper.setSubject(getSubject(type));
            helper.setText(getHtmlContent(code, type), true);
            
            mailSender.send(message);
            
        } catch (MessagingException e) {
            throw new EmailSendException("ì´ë©”ì¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤", e);
        }
    }
    
    private String getSubject(VerificationType type) {
        return type == VerificationType.SIGNUP
            ? "[ì†Œí”„íŠ¸ì›¨ì–´ìº í¼ìŠ¤] ì´ë©”ì¼ ì¸ì¦ ì½”ë“œ"
            : "[ì†Œí”„íŠ¸ì›¨ì–´ìº í¼ìŠ¤] ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì½”ë“œ";
    }
    
    private String getHtmlContent(String code, VerificationType type) {
        // HTML í…œí”Œë¦¿ ë°˜í™˜ (ìœ„ì˜ í…œí”Œë¦¿ ì‚¬ìš©)
        // ì‹¤ì œ êµ¬í˜„ ì‹œ Thymeleaf ë˜ëŠ” String ì¹˜í™˜ ì‚¬ìš©
    }
}
```

---

### 4. EmailVerificationService (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§)

```java
public interface EmailVerificationService {
    
    SendVerificationResponse sendVerificationCode(SendVerificationRequest request);
    
    VerifyCodeResponse verifyCode(VerifyCodeRequest request);
    
    SendVerificationResponse sendPasswordResetCode(String email);
    
    VerifyCodeResponse verifyPasswordResetCode(String email, String code);
}

@Service
@Transactional
@RequiredArgsConstructor
public class EmailVerificationServiceImpl implements EmailVerificationService {
    
    private final EmailVerificationRepository verificationRepository;
    private final AccountRepository accountRepository;
    private final EmailSendService emailSendService;
    
    @Value("${email.verification.expiry-minutes}")
    private int expiryMinutes;
    
    @Value("${email.verification.resend-cooldown-seconds}")
    private int resendCooldownSeconds;
    
    @Value("${email.verification.max-attempts}")
    private int maxAttempts;
    
    @Value("${email.verification.block-duration-minutes}")
    private int blockDurationMinutes;
    
    @Override
    public SendVerificationResponse sendVerificationCode(SendVerificationRequest request) {
        // 1. ì´ë©”ì¼ í˜•ì‹ ê²€ì¦
        if (!EmailUtils.isValidFormat(request.getEmail())) {
            throw new InvalidEmailFormatException("ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤");
        }
        
        // 2. ì°¨ë‹¨ ì—¬ë¶€ í™•ì¸ (ìµœëŒ€ ì‹œë„ ì´ˆê³¼)
        checkBlockStatus(request.getEmail(), request.getType());
        
        // 3. íšŒì›ê°€ì… ì¸ì¦ì˜ ê²½ìš° ì¤‘ë³µ ì´ë©”ì¼ ì²´í¬
        if (request.getType() == VerificationType.SIGNUP 
            && accountRepository.existsByEmail(request.getEmail())) {
            throw new DuplicateEmailException("ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤");
        }
        
        // 4. ì¬ì „ì†¡ ì¿¨ë‹¤ìš´ ì²´í¬
        checkResendCooldown(request.getEmail(), request.getType());
        
        // 4. ê¸°ì¡´ ì¸ì¦ ì½”ë“œ ë¬´íš¨í™”
        invalidateExistingVerification(request.getEmail(), request.getType());
        
        // 5. ìƒˆ ì¸ì¦ ì½”ë“œ ìƒì„±
        String code = VerificationCodeGenerator.generate();
        LocalDateTime expiresAt = LocalDateTime.now().plusMinutes(expiryMinutes);
        
        EmailVerification verification = EmailVerification.builder()
            .email(request.getEmail())
            .code(code)
            .type(request.getType())
            .expiresAt(expiresAt)
            .build();
        
        verificationRepository.save(verification);
        
        // 6. ì´ë©”ì¼ ë°œì†¡
        emailSendService.sendVerificationCode(request.getEmail(), code, request.getType());
        
        // 7. ì‘ë‹µ ìƒì„±
        return SendVerificationResponse.builder()
            .message("ì¸ì¦ ì½”ë“œê°€ ì´ë©”ì¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤")
            .email(request.getEmail())
            .expiresIn(expiryMinutes * 60)
            .canResendAt(LocalDateTime.now().plusSeconds(resendCooldownSeconds))
            .build();
    }
    
    @Override
    public VerifyCodeResponse verifyCode(VerifyCodeRequest request) {
        // 1. ì¸ì¦ ì½”ë“œ ì¡°íšŒ
        EmailVerification verification = verificationRepository
            .findByEmailAndTypeAndVerifiedFalse(request.getEmail(), request.getType())
            .orElseThrow(() -> new VerificationNotFoundException("ì¸ì¦ ìš”ì²­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"));
        
        // 2. ë§Œë£Œ í™•ì¸
        if (verification.isExpired()) {
            throw new VerificationCodeExpiredException("ì¸ì¦ ì½”ë“œê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤");
        }
        
        // 3. ìµœëŒ€ ì‹œë„ íšŸìˆ˜ í™•ì¸
        if (verification.isAttemptsExceeded()) {
            // 30ë¶„ ì°¨ë‹¨ ì„¤ì •
            verification.blockForDuration(blockDurationMinutes);
            verificationRepository.save(verification);
            
            throw new MaxAttemptsExceededException(
                String.format("ìµœëŒ€ ì‹œë„ íšŸìˆ˜ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. %dë¶„ í›„ì— ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”", blockDurationMinutes)
            );
        }
        
        // 4. ì½”ë“œ ê²€ì¦
        if (!verification.getCode().equals(request.getCode())) {
            verification.incrementAttempts();
            verificationRepository.save(verification);
            throw new InvalidVerificationCodeException("ì¸ì¦ ì½”ë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤");
        }
        
        // 5. ì¸ì¦ ì™„ë£Œ ì²˜ë¦¬
        verification.markAsVerified();
        verificationRepository.save(verification);
        
        return VerifyCodeResponse.builder()
            .verified(true)
            .message("ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤")
            .build();
    }
    
    private void checkBlockStatus(String email, VerificationType type) {
        Optional<EmailVerification> blocked = verificationRepository
            .findTopByEmailAndTypeOrderByCreatedAtDesc(email, type);
        
        if (blocked.isPresent() && blocked.get().isBlocked()) {
            long minutesLeft = blocked.get().getRemainingBlockMinutes();
            throw new EmailVerificationBlockedException(
                String.format("ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ì´ˆê³¼ë¡œ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. %dë¶„ í›„ì— ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”", minutesLeft)
            );
        }
    }
    
    private void checkResendCooldown(String email, VerificationType type) {
        LocalDateTime cooldownTime = LocalDateTime.now().minusSeconds(resendCooldownSeconds);
        
        if (verificationRepository.existsByEmailAndTypeAndVerifiedFalseAndCreatedAtAfter(
                email, type, cooldownTime)) {
            throw new ResendCooldownException(
                String.format("%dì´ˆ í›„ì— ì¬ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤", resendCooldownSeconds));
        }
    }
    
    private void invalidateExistingVerification(String email, VerificationType type) {
        verificationRepository.findByEmailAndTypeAndVerifiedFalse(email, type)
            .ifPresent(verificationRepository::delete);
    }
    
    // ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ê´€ë ¨ ë©”ì„œë“œëŠ” ìœ ì‚¬í•˜ê²Œ êµ¬í˜„
}
```

---

## âœ… í…ŒìŠ¤íŠ¸ ì „ëµ

### 1. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

#### VerificationCodeGeneratorTest
- 6ìë¦¬ ìˆ«ì ìƒì„± ê²€ì¦
- ë²”ìœ„ ê²€ì¦ (000000 ~ 999999)
- ê³ ìœ ì„± ê²€ì¦ (10000ê°œ ìƒì„± ì‹œ ì¤‘ë³µ ì—†ìŒ)

#### EmailVerificationServiceImplTest
- ì¸ì¦ ì½”ë“œ ë°œì†¡ ì„±ê³µ
- ì¤‘ë³µ ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨ (íšŒì›ê°€ì…)
- ì¬ì „ì†¡ ì¿¨ë‹¤ìš´ ê²€ì¦
- ì½”ë“œ ê²€ì¦ ì„±ê³µ
- ì½”ë“œ ë¶ˆì¼ì¹˜ ê²€ì¦
- ë§Œë£Œëœ ì½”ë“œ ê²€ì¦
- ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ì´ˆê³¼ ê²€ì¦

#### EmailSendServiceImplTest (Mock)
- JavaMailSender Mockìœ¼ë¡œ ë°œì†¡ ê²€ì¦
- ì˜ˆì™¸ ë°œìƒ ì‹œ EmailSendException ë³€í™˜

### 2. í†µí•© í…ŒìŠ¤íŠ¸

#### EmailVerificationIntegrationTest
- íšŒì›ê°€ì… í”Œë¡œìš°: ì½”ë“œ ë°œì†¡ â†’ ê²€ì¦ â†’ íšŒì›ê°€ì…
- ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • í”Œë¡œìš°: ì½”ë“œ ë°œì†¡ â†’ ê²€ì¦ â†’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
- ë§Œë£Œ ì‹œë‚˜ë¦¬ì˜¤ (ì‹œê°„ ì¡°ì‘)
- ì¬ì „ì†¡ ì‹œë‚˜ë¦¬ì˜¤

---

## ğŸš€ ë°°í¬ ê³ ë ¤ì‚¬í•­

### 1. Gmail ì•± ë¹„ë°€ë²ˆí˜¸ ìƒì„±
- Google ê³„ì • 2ë‹¨ê³„ ì¸ì¦ í™œì„±í™” í•„ìˆ˜
- ì•± ë¹„ë°€ë²ˆí˜¸ ìƒì„±: https://myaccount.google.com/apppasswords
- `.env` íŒŒì¼ì— `MAIL_APP_PASSWORD` ì„¤ì •

### 2. í”„ë¡œë•ì…˜ í™˜ê²½
- **SMTP íƒ€ì„ì•„ì›ƒ**: ì´ë¯¸ `application.properties`ì— ì„¤ì •ë¨ (5ì´ˆ)
- **ë°œì†¡ ë¡œê·¸**: ì„±ê³µ/ì‹¤íŒ¨ ì´ë ¥ì„ ë¡œê·¸ì— ê¸°ë¡ (PII ì œì™¸)
  ```java
  // EmailSendServiceImpl
  try {
      mailSender.send(message);
      log.info("ì´ë©”ì¼ ë°œì†¡ ì„±ê³µ - type: {}", type);
  } catch (MessagingException e) {
      log.error("ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨ - type: {}, error: {}", type, e.getMessage());
      throw new EmailSendException("ì´ë©”ì¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤", e);
  }
  ```
  
  **âš ï¸ PII ë³´í˜¸**: ìˆ˜ì‹ ì ì´ë©”ì¼ ì£¼ì†Œ(`to`)ëŠ” ê°œì¸ì •ë³´ì´ë¯€ë¡œ ë¡œê·¸ì— ê¸°ë¡í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

### 3. ë°°ì¹˜ ì‘ì—… (í•„ìˆ˜)
ë§Œë£Œëœ ì¸ì¦ ë°ì´í„°ë¥¼ ìë™ìœ¼ë¡œ ì •ë¦¬í•˜ì—¬ DB ìš©ëŸ‰ ê´€ë¦¬:

```java
@Component
@RequiredArgsConstructor
public class EmailVerificationCleanupScheduler {
    
    private final EmailVerificationRepository verificationRepository;
    
    @Scheduled(cron = "0 0 2 * * ?") // ë§¤ì¼ ìƒˆë²½ 2ì‹œ
    @Transactional
    public void cleanupExpiredVerifications() {
        LocalDateTime threshold = LocalDateTime.now().minusHours(24);
        
        // ì¸ì¦ ì™„ë£Œ í›„ 24ì‹œê°„ ì§€ë‚œ ë°ì´í„° ì‚­ì œ
        verificationRepository.deleteByExpiresAtBeforeAndVerifiedTrue(threshold);
        
        // ë¯¸ì¸ì¦ ìƒíƒœë¡œ 24ì‹œê°„ ì§€ë‚œ ë°ì´í„° ì‚­ì œ
        verificationRepository.deleteByCreatedAtBeforeAndVerifiedFalse(threshold);
        
        log.info("ë§Œë£Œëœ ì´ë©”ì¼ ì¸ì¦ ë°ì´í„° ì •ë¦¬ ì™„ë£Œ");
    }
}
```

**ì„¤ì • ì¶”ê°€ (`Application.java` ë˜ëŠ” ë³„ë„ Config)**:
```java
@EnableScheduling
@SpringBootApplication
public class Application {
    // ...
}
```

---

## ğŸ“Œ ì°¸ê³ ì‚¬í•­

### ë°ì´í„° ì €ì¥ ë°©ì‹
ì´ë©”ì¼ ì¸ì¦ ì½”ë“œëŠ” **DB(`email_verification` í…Œì´ë¸”)**ì—ë§Œ ì €ì¥í•©ë‹ˆë‹¤:
- **ì´ìœ :** ê°ì‚¬ ì¶”ì , ë²•ì  ë³´í˜¸, ë””ë²„ê¹… ìš©ì´ì„±
- **Redis ë¯¸ì‚¬ìš©:** ì¸ì¦ ë°ì´í„°ëŠ” ì˜ì†ì„±ì´ ì¤‘ìš”í•˜ë¯€ë¡œ DBë§Œ ì‚¬ìš©

### íšŒì›ê°€ì… í”Œë¡œìš° ë³€ê²½
ê¸°ì¡´ `SignupService`ì— ì´ë©”ì¼ ì¸ì¦ ì—¬ë¶€ í™•ì¸ ë¡œì§ ì¶”ê°€ í•„ìš”:
```java
// SignupServiceImpl.java
public AccountResponse signup(SignupRequest request) {
    // ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ ì—¬ë¶€ í™•ì¸
    boolean verified = verificationRepository.existsByEmailAndTypeAndVerifiedTrue(
        request.getEmail(), 
        VerificationType.SIGNUP
    );
    
    if (!verified) {
        throw new EmailNotVerifiedException("ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤");
    }
    
    // ê¸°ì¡´ íšŒì›ê°€ì… ë¡œì§...
}
```

---

## ğŸ“… êµ¬í˜„ ì¼ì • (ì˜ˆìƒ)

1. **Phase 1 (1ì¼):** ì˜ì¡´ì„± ì¶”ê°€, ì„¤ì •, ì—”í‹°í‹°/DTO ìƒì„±
2. **Phase 2 (1ì¼):** Repository, Util, ì´ë©”ì¼ í…œí”Œë¦¿
3. **Phase 3 (2ì¼):** Service êµ¬í˜„ (ë°œì†¡, ê²€ì¦)
4. **Phase 4 (1ì¼):** Controller, ì˜ˆì™¸ ì²˜ë¦¬
5. **Phase 5 (2ì¼):** ë‹¨ìœ„ í…ŒìŠ¤íŠ¸, í†µí•© í…ŒìŠ¤íŠ¸
6. **Phase 6 (1ì¼):** íšŒì›ê°€ì…/ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • í†µí•©, ê²€ì¦

**ì´ ì˜ˆìƒ ê¸°ê°„:** 7-8ì¼

---

## âœ¨ ì¶”ê°€ ê°œì„  ì‚¬í•­ (í–¥í›„)

1. **ì´ë©”ì¼ í…œí”Œë¦¿ ì—”ì§„:** Thymeleafë¡œ ë™ì  HTML ìƒì„±
2. **êµ­ì œí™”(i18n):** ë‹¤êµ­ì–´ ì§€ì› (í•œêµ­ì–´/ì˜ì–´)
3. **ì•Œë¦¼ ì„¤ì •:** ì‚¬ìš©ìê°€ ì´ë©”ì¼ ì•Œë¦¼ ìˆ˜ì‹  ì—¬ë¶€ ì„ íƒ
4. **OAuth ì¸ì¦:** Google/Kakao ë¡œê·¸ì¸ ì‹œ ì´ë©”ì¼ ì¸ì¦ ìƒëµ
5. **SMS ì¸ì¦:** ì´ë©”ì¼ ëŒ€ì‹  ë¬¸ì ì¸ì¦ ì˜µì…˜ ì œê³µ

---

**ì‘ì„±ì¼:** 2025ë…„ 1ì›” 15ì¼  
**ì‘ì„±ì:** íƒœìœ¤  
**ë¬¸ì„œ ë²„ì „:** 1.0
