# ì¡°íšŒìˆ˜ ì¤‘ë³µ ë°©ì§€ ê¸°ëŠ¥ ìš”ì²­

## ğŸ“‹ ê°œìš”

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ìš”ì²­ì¼** | 2025-12-02 |
| **ìƒíƒœ** | ğŸŸ¡ ë…¼ì˜ ì¤‘ |
| **ìš°ì„ ìˆœìœ„** | ì¤‘ê°„ |
| **ì˜í–¥ ë²”ìœ„** | ë°±ì—”ë“œ (Board ëª¨ë“ˆ) |

---

## ğŸ” í˜„ì¬ ìƒíƒœ

### ë¬¸ì œì 
```java
// BoardServiceImpl.java - getBoardById()
board.setHits(board.getHits() + 1);
```

- ê²Œì‹œê¸€ ìƒì„¸ ì¡°íšŒ ì‹œ **ë¬´ì¡°ê±´ ì¡°íšŒìˆ˜ +1**
- ìƒˆë¡œê³ ì¹¨í•´ë„ ì¦ê°€
- ì‘ì„±ì ë³¸ì¸ì´ ë´ë„ ì¦ê°€
- ê°™ì€ ì‚¬ìš©ìê°€ ì—¬ëŸ¬ ë²ˆ ë´ë„ ë§¤ë²ˆ ì¦ê°€

---

## âœ… ìš”êµ¬ì‚¬í•­

### ì¡°íšŒìˆ˜ ì¦ê°€ ì¡°ê±´

| ì‚¬ìš©ì ìœ í˜• | ì¡°íšŒìˆ˜ ì¦ê°€ ì¡°ê±´ |
|------------|-----------------|
| **ì‘ì„±ì ë³¸ì¸** | âŒ ì¦ê°€ ì•ˆí•¨ |
| **ë¡œê·¸ì¸ ì‚¬ìš©ì** | ì˜¤ëŠ˜ ì²« ì¡°íšŒì¼ ë•Œë§Œ +1 (account_id ê¸°ì¤€) |
| **ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì** | ì˜¤ëŠ˜ ì²« ì¡°íšŒì¼ ë•Œë§Œ +1 (IP ê¸°ì¤€) |

### í•˜ë£¨ ê¸°ì¤€
- ìì •(00:00) ê¸°ì¤€ ë¦¬ì…‹

---

## ğŸ¤” ì„¤ê³„ ê²°ì • ì‚¬í•­

| # | í•­ëª© | ê²°ì • | ì‚¬ìœ  |
|---|------|------|------|
| 1 | Serviceì— Request ì „ë‹¬ | âŒ IPë¥¼ Stringìœ¼ë¡œ ì „ë‹¬ | Service ë ˆì´ì–´ HTTP ì˜ì¡´ì„± ì œê±°, í…ŒìŠ¤íŠ¸ ìš©ì´ |
| 2 | ë™ì‹œì„± ì¤‘ë³µ | ë¬´ì‹œ | ë“œë¬¸ ì¼€ì´ìŠ¤, ë¹„ìš© ëŒ€ë¹„ íš¨ê³¼ ë‚®ìŒ |
| 3 | ê³µìœ  IP ë¬¸ì œ | ê°ìˆ˜ | ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì ì •í™•ë„ëŠ” ë‚®ì•„ë„ OK |
| 4 | í…Œì´ë¸” í¬ê¸° | 30ì¼ í›„ ì‚­ì œ | ìŠ¤ì¼€ì¤„ëŸ¬ë¡œ ìë™ ì •ë¦¬ |
| 5 | ê¸°ì¡´ ì¡°íšŒìˆ˜ | ìœ ì§€ | ë°ì´í„° ì†ì‹¤ ë°©ì§€ |
| 6 | ë¹„ë¡œê·¸ì¸â†’ë¡œê·¸ì¸ ì „í™˜ | í—ˆìš© | ì–´ì°¨í”¼ í•˜ë£¨ 2ë²ˆ, ë³µì¡ë„ ëŒ€ë¹„ íš¨ê³¼ ë‚®ìŒ |

---

## ğŸ—„ï¸ DB ì„¤ê³„

### ì‹ ê·œ í…Œì´ë¸”: `board_view`

```sql
CREATE TABLE board_view (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    board_id BIGINT NOT NULL,
    account_id BIGINT NULL,           -- ë¡œê·¸ì¸ ì‚¬ìš©ì (nullable)
    ip_address VARCHAR(45) NULL,      -- ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ììš© (IPv6 ì§€ì›)
    viewed_at DATETIME NOT NULL,
    
    CONSTRAINT fk_board_view_board 
        FOREIGN KEY (board_id) REFERENCES board(id) ON DELETE CASCADE,
    CONSTRAINT fk_board_view_account 
        FOREIGN KEY (account_id) REFERENCES account(id) ON DELETE CASCADE,
    
    -- ì¤‘ë³µ ë°©ì§€ ë° ì¡°íšŒ ì„±ëŠ¥ìš© ì¸ë±ìŠ¤
    INDEX idx_board_view_account (board_id, account_id, viewed_at),
    INDEX idx_board_view_ip (board_id, ip_address, viewed_at)
);
```

### í•„ë“œ ì„¤ëª…

| í•„ë“œ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `id` | BIGINT | PK, Auto Increment |
| `board_id` | BIGINT | ê²Œì‹œê¸€ FK (NOT NULL) |
| `account_id` | BIGINT | ë¡œê·¸ì¸ ì‚¬ìš©ì FK (NULL ê°€ëŠ¥) |
| `ip_address` | VARCHAR(45) | ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì IP (IPv6 ëŒ€ì‘) |
| `viewed_at` | DATETIME | ì¡°íšŒ ì¼ì‹œ |

---

## ğŸ”§ êµ¬í˜„ ëª…ì„¸

### 1. ì—”í‹°í‹° ìƒì„±

```java
@Entity
@Table(name = "board_view")
@Builder
@AllArgsConstructor
@NoArgsConstructor
@Getter
public class BoardView {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "board_id", nullable = false)
    private Board board;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "account_id")
    private Account account;  // nullable

    @Column(name = "ip_address", length = 45)
    private String ipAddress;  // nullable

    @CreationTimestamp
    @Column(name = "viewed_at", nullable = false)
    private LocalDateTime viewedAt;
}
```

### 2. Repository

```java
public interface BoardViewRepository extends JpaRepository<BoardView, Long> {
    
    // ë¡œê·¸ì¸ ì‚¬ìš©ì: ì˜¤ëŠ˜ ì¡°íšŒ ê¸°ë¡ í™•ì¸
    @Query("SELECT COUNT(bv) > 0 FROM BoardView bv " +
           "WHERE bv.board.id = :boardId " +
           "AND bv.account.id = :accountId " +
           "AND DATE(bv.viewedAt) = CURRENT_DATE")
    boolean existsTodayViewByAccount(
        @Param("boardId") Long boardId, 
        @Param("accountId") Long accountId
    );
    
    // ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì: ì˜¤ëŠ˜ IP ê¸°ì¤€ ì¡°íšŒ ê¸°ë¡ í™•ì¸
    @Query("SELECT COUNT(bv) > 0 FROM BoardView bv " +
           "WHERE bv.board.id = :boardId " +
           "AND bv.ipAddress = :ipAddress " +
           "AND DATE(bv.viewedAt) = CURRENT_DATE")
    boolean existsTodayViewByIp(
        @Param("boardId") Long boardId, 
        @Param("ipAddress") String ipAddress
    );
    
    // ì˜¤ë˜ëœ ê¸°ë¡ ì‚­ì œìš©
    void deleteByViewedAtBefore(LocalDateTime threshold);
}
```

### 3. Controller ìˆ˜ì • (IP ì¶”ì¶œ)

```java
@GetMapping("/{id}")
public ResponseEntity<BoardResponseDTO> getBoardById(
        @PathVariable Long id,
        @AuthenticationPrincipal CustomUserDetails userDetails,
        HttpServletRequest request
) {
    Long userId = userDetails != null ? userDetails.getUserId() : null;
    String clientIp = getClientIp(request);  // Controllerì—ì„œ IP ì¶”ì¶œ
    return ResponseEntity.ok(boardService.getBoardById(id, userId, clientIp));
}

private String getClientIp(HttpServletRequest request) {
    String ip = request.getHeader("X-Forwarded-For");
    if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
        ip = request.getHeader("X-Real-IP");
    }
    if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
        ip = request.getRemoteAddr();
    }
    // X-Forwarded-Forì— ì—¬ëŸ¬ IPê°€ ìˆì„ ê²½ìš° ì²« ë²ˆì§¸ê°€ í´ë¼ì´ì–¸íŠ¸ IP
    if (ip != null && ip.contains(",")) {
        ip = ip.split(",")[0].trim();
    }
    return ip;
}
```

### 4. Service ë¡œì§ ìˆ˜ì •

```java
// ì¸í„°í˜ì´ìŠ¤
BoardResponseDTO getBoardById(Long id, Long userId, String clientIp);

// êµ¬í˜„ì²´
@Override
public BoardResponseDTO getBoardById(Long id, Long userId, String clientIp) {
    Board board = boardRepository.findById(id)
            .orElseThrow(() -> new BoardException(BoardErrorCode.BOARD_NOT_FOUND));
    
    // ì‚­ì œëœ ê¸€ ì¡°íšŒ ë¶ˆê°€ ì²˜ë¦¬
    if (!board.isActive()) {
        throw new BoardException(BoardErrorCode.BOARD_NOT_FOUND);
    }
    if (board.isSecret() && (userId == null || !userId.equals(board.getAccount().getId()))) {
        throw new BoardException(BoardErrorCode.CANNOT_READ_BOARD);
    }
    
    // ì¡°íšŒìˆ˜ ì¦ê°€ ë¡œì§ (ì¤‘ë³µ ë°©ì§€)
    incrementHitsIfAllowed(board, userId, clientIp);
    
    BoardResponseDTO boardResponseDTO = BoardResponseDTO.from(board, userId);
    if (userId != null) {
        boardResponseDTO.setLike(
                board.getBoardRecommends().stream().anyMatch(br -> br.getAccount().getId().equals(userId)));
        boardResponseDTO.setOwner(userId.equals(board.getAccount().getId()));
    }
    return boardResponseDTO;
}

private void incrementHitsIfAllowed(Board board, Long userId, String clientIp) {
    // 1. ì‘ì„±ì ë³¸ì¸ì´ë©´ ì¦ê°€ ì•ˆí•¨
    if (userId != null && userId.equals(board.getAccount().getId())) {
        return;
    }
    
    boolean alreadyViewed;
    
    if (userId != null) {
        // 2. ë¡œê·¸ì¸ ì‚¬ìš©ì: account_id ê¸°ì¤€
        alreadyViewed = boardViewRepository.existsTodayViewByAccount(board.getId(), userId);
    } else {
        // 3. ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì: IP ê¸°ì¤€
        alreadyViewed = boardViewRepository.existsTodayViewByIp(board.getId(), clientIp);
    }
    
    if (!alreadyViewed) {
        // ì¡°íšŒìˆ˜ ì¦ê°€
        board.setHits(board.getHits() + 1);
        
        // ì¡°íšŒ ê¸°ë¡ ì €ì¥
        BoardView boardView = BoardView.builder()
                .board(board)
                .account(userId != null ? accountRepository.getReferenceById(userId) : null)
                .ipAddress(userId == null ? clientIp : null)
                .build();
        boardViewRepository.save(boardView);
    }
}
```

---

## ğŸ“ ìƒì„±/ìˆ˜ì • íŒŒì¼ ëª©ë¡

### ì‹ ê·œ ìƒì„±
| íŒŒì¼ | ì„¤ëª… |
|------|------|
| `domain/board/BoardView.java` | ì¡°íšŒ ê¸°ë¡ ì—”í‹°í‹° |
| `repository/board/BoardViewRepository.java` | ì¡°íšŒ ê¸°ë¡ Repository |

### ìˆ˜ì • í•„ìš”
| íŒŒì¼ | ìˆ˜ì • ë‚´ìš© |
|------|----------|
| `service/board/BoardService.java` | ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜ì— `String clientIp` ì¶”ê°€ |
| `service/board/BoardServiceImpl.java` | ì¡°íšŒìˆ˜ ì¦ê°€ ë¡œì§ ë³€ê²½, `boardViewRepository` ì£¼ì… |
| `controller/board/BoardController.java` | IP ì¶”ì¶œ í›„ Serviceì— ì „ë‹¬ |

---

## ğŸ”„ ë°ì´í„° ì •ë¦¬ (30ì¼ í›„ ìë™ ì‚­ì œ)

```java
@Component
@RequiredArgsConstructor
public class BoardViewCleanupScheduler {
    
    private final BoardViewRepository boardViewRepository;
    
    // ë§¤ì¼ ìƒˆë²½ 3ì‹œì— 30ì¼ ì´ìƒ ëœ ê¸°ë¡ ì‚­ì œ
    @Scheduled(cron = "0 0 3 * * ?")
    @Transactional
    public void cleanupOldViewRecords() {
        LocalDateTime threshold = LocalDateTime.now().minusDays(30);
        boardViewRepository.deleteByViewedAtBefore(threshold);
    }
}
```

> âš ï¸ `@EnableScheduling`ì´ Application í´ë˜ìŠ¤ì— ìˆì–´ì•¼ í•¨

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

1. **ì„±ëŠ¥**: ì¡°íšŒë§ˆë‹¤ DB ì²´í¬ â†’ ì¸ë±ìŠ¤ í•„ìˆ˜
2. **IPv6**: `ip_address` ì»¬ëŸ¼ 45ì (IPv6 ìµœëŒ€ ê¸¸ì´)
3. **í”„ë¡ì‹œ**: `X-Forwarded-For` í—¤ë” ìš°ì„  ì‚¬ìš©
4. **í…ŒìŠ¤íŠ¸**: ë¡œê·¸ì¸/ë¹„ë¡œê·¸ì¸, ì‘ì„±ì ë³¸ì¸ ì¼€ì´ìŠ¤ ëª¨ë‘ í…ŒìŠ¤íŠ¸ í•„ìš”
5. **ê¸°ì¡´ ë°ì´í„°**: ê¸°ì¡´ ì¡°íšŒìˆ˜(`hits`)ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ë¨

---

## ğŸ“ ê´€ë ¨ ë¬¸ì„œ

- [01_í”„ë¡ íŠ¸ì—”ë“œ_ì—°ë™_ìš”ì²­ì‚¬í•­.md](./01_í”„ë¡ íŠ¸ì—”ë“œ_ì—°ë™_ìš”ì²­ì‚¬í•­.md)
- [COMMUNITY_INTEGRATION_REPORT.md](./COMMUNITY_INTEGRATION_REPORT.md)
