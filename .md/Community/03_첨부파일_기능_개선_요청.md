# ì²¨ë¶€íŒŒì¼ ê¸°ëŠ¥ ê°œì„  ìš”ì²­

> **ì‘ì„±ì¼**: 2025ë…„ 12ì›” 2ì¼  
> **ë¸Œëœì¹˜**: `Community-Integration`  
> **ìš°ì„ ìˆœìœ„**: ë†’ìŒ  
> **ìƒíƒœ**: ìš”ì²­ë¨

---

## ğŸ“‹ ê°œìš”

ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œíŒì˜ ì²¨ë¶€íŒŒì¼ ê¸°ëŠ¥ì— ëŒ€í•œ ë°±ì—”ë“œ ê°œì„  ìš”ì²­ì…ë‹ˆë‹¤.  
í˜„ì¬ ë¡œì§ì˜ ë¯¸ì™„ì„± ë¶€ë¶„ì„ ë³´ì™„í•˜ê³ , í”„ë¡ íŠ¸ì—”ë“œ ì—°ë™ì„ ìœ„í•œ ê¸°ëŠ¥ì„ ì¶”ê°€í•©ë‹ˆë‹¤.

---

## ğŸ”´ í˜„ì¬ ë¬¸ì œì 

### 1. íŒŒì¼ ê°œìˆ˜ ì œí•œ ì—†ìŒ

í˜„ì¬ ë°±ì—”ë“œì— ì²¨ë¶€íŒŒì¼ ê°œìˆ˜ ì œí•œì´ ì—†ì–´ì„œ ë¬´ì œí•œ ì—…ë¡œë“œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.

- **íŒŒì¼ í¬ê¸° ì œí•œ**: âœ… ìˆìŒ (íŒŒì¼ë‹¹ 50MB)
- **íŒŒì¼ íƒ€ì… ì œí•œ**: âœ… ìˆìŒ (í™•ì¥ì/MIME ê²€ì¦)
- **íŒŒì¼ ê°œìˆ˜ ì œí•œ**: âŒ ì—†ìŒ â† **ì¶”ê°€ í•„ìš”**

### 2. ê²Œì‹œê¸€ ìˆ˜ì • ì‹œ íŒŒì¼ ì „ì²´ ì‚­ì œ ë¬¸ì œ

**í˜„ì¬ ë¡œì§** (`BoardServiceImpl.updateBoard`):
```java
if (files != null && files.length > 0) {
    // ê¸°ì¡´ íŒŒì¼ ì „ë¶€ ì‚­ì œ (ë¬¸ì œ!)
    if (boardAttachList.size() > 0) {
        for (BoardAttach boardAttach : board.getBoardAttaches()) {
            deleteFile(boardAttach);
            boardAttach.markDeleted();
            boardAttachRepository.save(boardAttach);
        }
    }
    // ìƒˆ íŒŒì¼ ì¶”ê°€
    for (MultipartFile file : files) {
        BoardAttach boardAttach = uploadFile(file);
        boardAttach.setBoard(board);
        boardAttachList.add(boardAttach);
    }
}
```

**ë¬¸ì œ ì‹œë‚˜ë¦¬ì˜¤**:
| ìƒí™© | ê²°ê³¼ |
|------|------|
| ê¸°ì¡´ íŒŒì¼ 3ê°œ â†’ ìˆ˜ì • ì‹œ íŒŒì¼ 1ê°œ ì¶”ê°€ | âŒ ê¸°ì¡´ 3ê°œ ì‚­ì œ, ìƒˆ 1ê°œë§Œ ë‚¨ìŒ |
| ê¸°ì¡´ íŒŒì¼ 3ê°œ â†’ ìˆ˜ì • ì‹œ íŒŒì¼ ì•ˆ ì˜¬ë¦¼ | âœ… ê¸°ì¡´ 3ê°œ ìœ ì§€ |

ì‚¬ìš©ìê°€ íŒŒì¼ì„ ì¶”ê°€í•˜ë ¤ê³  í•˜ë©´ **ê¸°ì¡´ íŒŒì¼ì´ ëª¨ë‘ ì‚­ì œ**ë˜ëŠ” ë¬¸ì œ ë°œìƒ.

---

## âœ… ìš”ì²­ ì‚¬í•­

### ìš”ì²­ 1: íŒŒì¼ ê°œìˆ˜ ì œí•œ ì„¤ì • ì¶”ê°€

#### 1-1. í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€ (`.env`)

```properties
# ===== ê²Œì‹œíŒ ì²¨ë¶€íŒŒì¼ (board_attach í…Œì´ë¸”) =====
# ê¸°ì¡´ ì„¤ì •
FILE_UPLOAD_BOARD_ATTACH_EXTENSIONS=jpg,jpeg,png,gif,webp,pdf,doc,docx,xls,xlsx,ppt,pptx,txt,md,csv,zip,rar
FILE_UPLOAD_BOARD_ATTACH_MAX_SIZE=52428800

# ì‹ ê·œ ì¶”ê°€
FILE_UPLOAD_BOARD_ATTACH_MAX_COUNT=5
```

#### 1-2. application.properties ì¶”ê°€

```properties
# ê²Œì‹œíŒ ì²¨ë¶€íŒŒì¼ ìµœëŒ€ ê°œìˆ˜
file.upload.board-attach.max-count=${FILE_UPLOAD_BOARD_ATTACH_MAX_COUNT:5}
```

#### 1-3. FileType.java ìˆ˜ì •

```java
// í•„ë“œ ì¶”ê°€
@Value("${file.upload.board-attach.max-count}")
private int boardAttachMaxCount;

// FileTypeConfigì— maxCount ì¶”ê°€
public record FileTypeConfig(
    Set<String> allowedExtensions,
    Set<String> allowedContentTypes,
    long maxFileSize,
    int maxCount  // ì‹ ê·œ ì¶”ê°€
) { ... }
```

#### 1-4. BoardServiceImpl ê²€ì¦ ë¡œì§ ì¶”ê°€

```java
// createBoard, updateBoardì—ì„œ ê²€ì¦
if (files != null && files.length > MAX_FILE_COUNT) {
    throw new BoardException(BoardErrorCode.FILE_COUNT_EXCEEDED);
}
```

#### 1-5. BoardErrorCode ì¶”ê°€

```java
FILE_COUNT_EXCEEDED(HttpStatus.BAD_REQUEST, "ì²¨ë¶€íŒŒì¼ì€ ìµœëŒ€ %dê°œê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.")
```

---

### ìš”ì²­ 2: ì„ íƒì  íŒŒì¼ ì‚­ì œ/ì¶”ê°€ ê¸°ëŠ¥

#### 2-1. BoardUpdateRequestDTO ìˆ˜ì •

```java
public class BoardUpdateRequestDTO {
    @NotNull
    private Long id;
    
    private String title;
    private String text;
    private Boolean secret;
    
    // ì‹ ê·œ ì¶”ê°€: ì‚­ì œí•  ì²¨ë¶€íŒŒì¼ ID ëª©ë¡
    private List<Long> deleteAttachIds;
}
```

#### 2-2. BoardController ìˆ˜ì •

```java
@PatchMapping("/{id}")
public ResponseEntity<Void> updateBoard(
        @PathVariable Long id,
        @ModelAttribute BoardUpdateRequestDTO boardUpdateRequestDTO,
        @RequestParam(required = false) MultipartFile[] files,
        @RequestParam(required = false) List<Long> deleteAttachIds,  // ì¶”ê°€
        @AuthenticationPrincipal CustomUserDetails userDetails) {
    
    boardUpdateRequestDTO.setDeleteAttachIds(deleteAttachIds);
    boardService.updateBoard(boardUpdateRequestDTO, files);
    return ResponseEntity.noContent().build();
}
```

#### 2-3. BoardServiceImpl.updateBoard ìˆ˜ì •

```java
@Transactional
@Override
public void updateBoard(BoardUpdateRequestDTO boardUpdateRequestDTO, MultipartFile[] files) {
    Board board = boardRepository.findById(boardUpdateRequestDTO.getId())
            .orElseThrow(() -> new BoardException(BoardErrorCode.BOARD_NOT_FOUND));
    
    if (!board.isActive()) {
        throw new BoardException(BoardErrorCode.BOARD_NOT_FOUND);
    }
    
    List<BoardAttach> boardAttachList = board.getBoardAttaches();
    
    // 1. ì„ íƒì  íŒŒì¼ ì‚­ì œ (deleteAttachIdsì— ìˆëŠ” íŒŒì¼ë§Œ ì‚­ì œ)
    List<Long> deleteAttachIds = boardUpdateRequestDTO.getDeleteAttachIds();
    if (deleteAttachIds != null && !deleteAttachIds.isEmpty()) {
        for (BoardAttach boardAttach : boardAttachList) {
            if (deleteAttachIds.contains(boardAttach.getId())) {
                deleteFile(boardAttach);
                boardAttach.markDeleted();
                boardAttachRepository.save(boardAttach);
            }
        }
    }
    
    // 2. ìƒˆ íŒŒì¼ ì¶”ê°€
    if (files != null && files.length > 0) {
        // í˜„ì¬ í™œì„± íŒŒì¼ ê°œìˆ˜ + ìƒˆ íŒŒì¼ ê°œìˆ˜ ê²€ì¦
        long activeFileCount = boardAttachList.stream()
                .filter(BoardAttach::isActive)
                .count();
        
        if (activeFileCount + files.length > MAX_FILE_COUNT) {
            throw new BoardException(BoardErrorCode.FILE_COUNT_EXCEEDED);
        }
        
        for (MultipartFile file : files) {
            BoardAttach boardAttach = uploadFile(file);
            boardAttach.setBoard(board);
            boardAttachList.add(boardAttach);
        }
    }
    
    boardUpdateRequestDTO.updateEntity(board);
}
```

---

## ğŸ“¡ API ë³€ê²½ ì‚¬í•­

### PATCH /api/boards/{id}

#### Request (multipart/form-data)

| í•„ë“œ | íƒ€ì… | í•„ìˆ˜ | ì„¤ëª… |
|------|------|------|------|
| `id` | Long | âœ… | ê²Œì‹œê¸€ ID |
| `title` | String | âŒ | ìˆ˜ì •í•  ì œëª© |
| `text` | String | âŒ | ìˆ˜ì •í•  ë‚´ìš© |
| `secret` | Boolean | âŒ | ë¹„ë°€ê¸€ ì—¬ë¶€ |
| `category` | String | âŒ | ì¹´í…Œê³ ë¦¬ (ì‹ ê·œ) |
| `files` | MultipartFile[] | âŒ | ìƒˆë¡œ ì¶”ê°€í•  íŒŒì¼ |
| `deleteAttachIds` | List\<Long\> | âŒ | **ì‚­ì œí•  ì²¨ë¶€íŒŒì¼ ID ëª©ë¡ (ì‹ ê·œ)** |

#### ì‚¬ìš© ì˜ˆì‹œ

```javascript
const formData = new FormData();
formData.append('id', postId);
formData.append('title', 'ìˆ˜ì •ëœ ì œëª©');
formData.append('text', 'ìˆ˜ì •ëœ ë‚´ìš©');

// ì‚­ì œí•  íŒŒì¼ ID (ê¸°ì¡´ ì²¨ë¶€íŒŒì¼ ì¤‘ ì‚­ì œí•  ê²ƒ)
formData.append('deleteAttachIds', 15);
formData.append('deleteAttachIds', 23);

// ìƒˆë¡œ ì¶”ê°€í•  íŒŒì¼
formData.append('files', newFile1);
formData.append('files', newFile2);
```

---

## ğŸ“Š ì˜ˆìƒ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ê¸°ì¡´ íŒŒì¼ ìœ ì§€ + ìƒˆ íŒŒì¼ ì¶”ê°€
- ê¸°ì¡´ íŒŒì¼: [A, B, C]
- ìš”ì²­: `files=[D]`, `deleteAttachIds=[]`
- ê²°ê³¼: [A, B, C, D] âœ…

### ì‹œë‚˜ë¦¬ì˜¤ 2: ì¼ë¶€ íŒŒì¼ ì‚­ì œ + ìƒˆ íŒŒì¼ ì¶”ê°€
- ê¸°ì¡´ íŒŒì¼: [A, B, C]
- ìš”ì²­: `files=[D, E]`, `deleteAttachIds=[Bì˜ ID]`
- ê²°ê³¼: [A, C, D, E] âœ…

### ì‹œë‚˜ë¦¬ì˜¤ 3: íŒŒì¼ë§Œ ì‚­ì œ
- ê¸°ì¡´ íŒŒì¼: [A, B, C]
- ìš”ì²­: `files=[]`, `deleteAttachIds=[Aì˜ ID, Bì˜ ID]`
- ê²°ê³¼: [C] âœ…

### ì‹œë‚˜ë¦¬ì˜¤ 4: ê°œìˆ˜ ì œí•œ ì´ˆê³¼
- ê¸°ì¡´ íŒŒì¼: [A, B, C, D] (4ê°œ)
- ìš”ì²­: `files=[E, F]` (2ê°œ ì¶”ê°€ â†’ ì´ 6ê°œ)
- ê²°ê³¼: âŒ `FILE_COUNT_EXCEEDED` ì—ëŸ¬

---

## ğŸ—‚ï¸ ìˆ˜ì • ëŒ€ìƒ íŒŒì¼

| íŒŒì¼ | ìˆ˜ì • ë‚´ìš© |
|------|----------|
| `.env` | `FILE_UPLOAD_BOARD_ATTACH_MAX_COUNT` ì¶”ê°€ |
| `application.properties` | `file.upload.board-attach.max-count` ì¶”ê°€ |
| `FileType.java` | `maxCount` í•„ë“œ ë° ì„¤ì • ì¶”ê°€ |
| `BoardErrorCode.java` | `FILE_COUNT_EXCEEDED` ì—ëŸ¬ ì½”ë“œ ì¶”ê°€ |
| `BoardUpdateRequestDTO.java` | `deleteAttachIds` í•„ë“œ ì¶”ê°€ |
| `BoardController.java` | `deleteAttachIds` íŒŒë¼ë¯¸í„° ì¶”ê°€ |
| `BoardServiceImpl.java` | ì„ íƒì  ì‚­ì œ ë¡œì§ + ê°œìˆ˜ ê²€ì¦ ì¶”ê°€ |

---

## âœ… ì™„ë£Œ í›„ í”„ë¡ íŠ¸ì—”ë“œ ì‘ì—…

ë°±ì—”ë“œ ìˆ˜ì • ì™„ë£Œ í›„ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ êµ¬í˜„í•  ë‚´ìš©:

1. **ê¸€ì“°ê¸° í˜ì´ì§€** - íŒŒì¼ ì—…ë¡œë“œ UI (ìµœëŒ€ 5ê°œ)
2. **ê¸€ìˆ˜ì • í˜ì´ì§€** - ê¸°ì¡´ íŒŒì¼ ëª©ë¡ + ì‚­ì œ ì²´í¬ë°•ìŠ¤ + ìƒˆ íŒŒì¼ ì¶”ê°€
3. **ê¸€ìƒì„¸ í˜ì´ì§€** - ì²¨ë¶€íŒŒì¼ ëª©ë¡ + ë‹¤ìš´ë¡œë“œ ë²„íŠ¼

---

## ğŸ“… ì¼ì •

| ë‹¨ê³„ | ì˜ˆìƒ ì†Œìš” |
|------|----------|
| ë°±ì—”ë“œ ìˆ˜ì • | 1~2ì‹œê°„ |
| í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„ | 2~3ì‹œê°„ |
| í…ŒìŠ¤íŠ¸ | 1ì‹œê°„ |

---

## ğŸ“Œ ì°¸ê³ 

- í˜„ì¬ íŒŒì¼ í¬ê¸° ì œí•œ: íŒŒì¼ë‹¹ 50MB
- í—ˆìš© í™•ì¥ì: jpg, jpeg, png, gif, webp, pdf, doc, docx, xls, xlsx, ppt, pptx, txt, md, csv, zip, rar
